# For now, this just downloads all extensions immediately available on the
# front page of the extensions store.  We'll want to follow a bunch of
# links out to get as many extensions as possible.

from selenium import webdriver
from re import findall
from urllib.request import urlretrieve

CHROMEDRIVER_PATH = "/Users/firechant/Projects/Chrome-XSS-Vulnerability/get_extensions/chromedriver"
CHROME_VERSION = "57.0.2987.133"

DOWNLOAD_FOLDER = "extensions/" # MUST end with "/"
STORE_URL = "https://chrome.google.com/webstore/category/extensions"
id_regex = r"""/webstore/detail/.+?/([a-z]{32})"""

def get_download_url(ext_id):
    return "https://clients2.google.com/service/update2/crx?response=redirect&prodversion=" + CHROME_VERSION + "&x=id%3D" + ext_id + "%26uc"

def get_ids_from_source(source):
    return findall(id_regex, source)

# Drive Chrome
browser = webdriver.Chrome(executable_path=CHROMEDRIVER_PATH)
browser.get(STORE_URL)

downloaded = set()
# Get all extensions on this page, add their IDs to a set
new_ids = get_ids_from_source(browser.page_source)

# download all of these:
for eid in new_ids:
    if eid in downloaded:
        continue
    urlretrieve(get_download_url(eid), DOWNLOAD_FOLDER + eid + ".crx")
    downloaded.add(eid)











