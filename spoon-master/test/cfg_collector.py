import sys
import os
import subprocess
import tempfile

#extension_path = '/home/heinous/.config/google-chrome/Default/Extensions/'
extension_path = '/Users/firechant/Projects/Chrome-XSS-Vulnerability/get_extensions/unpacked_extensions/'

CFG_DIR = './CFG_files'

def get_immediate_subdirectories(a_dir):
    return [name for name in os.listdir(a_dir)
            if os.path.isdir(os.path.join(a_dir, name))]

def get_js_file(extension):
    path = extension_path + extension
    js_files = {}
    for root, dirs, files in os.walk(path):
        for file in files:
            if file.endswith("js"):
                js_files[file] = os.path.join(root, file)
    return js_files

extensions = get_immediate_subdirectories(extension_path)
if os.path.exists(CFG_DIR) == False:
    os.system("mkdir " + CFG_DIR)

for extension in extensions:
    files = get_js_file(extension)
    if os.path.exists(CFG_DIR + "/" + extension) == False:
        os.system("mkdir " + CFG_DIR + "/" + extension)

    for file in files:
        if len(file) != 0:
            f = open(CFG_DIR + '/' + extension + "/" + file, 'w')

            with tempfile.TemporaryFile() as tempf:
                print files[file]
                p = subprocess.Popen(['node', 'file_to_cfg.js', files[file]], stdout=tempf)
                p.wait()
                tempf.seek(0)
                f.write(tempf.read().decode('ascii'))
            f.close()


