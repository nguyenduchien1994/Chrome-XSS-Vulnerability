import sys
import os
import subprocess
import tempfile

#extension_path = '/home/heinous/.config/google-chrome/Default/Extensions/'
#extension_path = '/Users/firechant/Projects/Chrome-XSS-Vulnerability/get_extensions/unpacked_extensions/'
extension_path = '/home/ubuntu/Chrome-XSS-Vulnerability/get_extensions/unpacked_extensions/'
#extension_path = '/home/ubuntu/Chrome-XSS-Vulnerability/spoon-master/test/'
#extension_path = '/home/ubuntu/Chrome-XSS-Vulnerability/ext/'

CFG_DIR = '/home/ubuntu/Chrome-XSS-Vulnerability/spoon-master/test/CFG_files'

def get_immediate_subdirectories(a_dir):
    """Returns all top-level subdirectories of given folder in a list"""
    return [name for name in os.listdir(a_dir)
            if os.path.isdir(os.path.join(a_dir, name))]

def get_js_file(extension):
    """Gets all javascript files within an extension folder"""
    path = extension_path + extension
    js_files = {}
    for root, dirs, files in os.walk(path):
        for f in files:
            if f.endswith("js"):
                js_files[f] = os.path.join(root, f)
    return js_files

extensions = get_immediate_subdirectories(extension_path)
if os.path.exists(CFG_DIR) == False:
    os.system("mkdir " + CFG_DIR)

for extension in extensions:
    files = get_js_file(extension)
    if os.path.exists(CFG_DIR + "/" + extension) == False:
        os.system("mkdir " + CFG_DIR + "/" + extension)

    for fi in files:
        print fi
        if len(fi) != 0:
            print fi
            f = open(CFG_DIR + '/' + extension + "/" + fi + '.cfg', 'w')

            with tempfile.TemporaryFile() as tempf:
                try:
                    print files[fi]
                    p = subprocess.Popen(['node', 'file_to_cfg.js', files[fi]], stdout=tempf)
                    p.wait()
                    tempf.seek(0)
                    f.write(tempf.read().decode('ascii'))
                except:
                    print "skipping this"
            f.close()


